<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë„ì„œ ê²€ìƒ‰ ê²°ê³¼</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var loggedInUser = "[[${session.nickname}]]";

        function bookmarkBook(button) {
            if (!loggedInUser || loggedInUser === "null") {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }
            const bookTitle = button.getAttribute("data-title");
            const bookAuth = button.getAttribute("data-auth");
            const bookPub = button.getAttribute("data-pub");
            const bookPubYear = button.getAttribute("data-pubyear");
            const des = button.getAttribute("data-des");
            const link = button.getAttribute("data-link");
            const discount = button.getAttribute("data-discount");
            const ISBN = button.getAttribute("data-isbn");
            const img = button.getAttribute("data-img");

            $.ajax({
                type: "POST",
                url: "/bookmark",
                contentType: "application/x-www-form-urlencoded",
                data: {
                    bookTitle: bookTitle,
                    bookAuth: bookAuth,
                    bookPub: bookPub,
                    bookPubYear: bookPubYear,
                    des: des,
                    link:link,
                    discount: discount,
                    ISBN: ISBN,
                    img: img
                },
                success: function(response) {
                    alert("ë¶ë§ˆí¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
                },
                error: function() {
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
    </script>
    <link rel="stylesheet" th:href="@{/css/book_page_style.css}">
</head>
<body>

<a th:href="@{/}">
    <div class="logo-container">
        <img src="/images/logo.png" alt="ì‚¬ì´íŠ¸ ë¡œê³ ">
    </div>
</a>

<form th:action="@{/books}" method="get">
    <input type="text" id="searchText" name="searchText" required>
    <button class="search-button" type="submit">ê²€ìƒ‰</button>
</form>

<h1>ğŸ“š ë„ì„œ ê²€ìƒ‰ ê²°ê³¼</h1>
<h2>ì´ ê²€ìƒ‰ ê²°ê³¼: <span th:text="${totalResults}"></span>ê¶Œ</h2>

<div class="book-list">
    <div class="book-card" th:each="book : ${books}">
        <a th:href="@{/books/detail/{title}(title=${book.bookTitle})}">
            <img th:src="${book.img}" alt="Book Image"
                 onerror="this.onerror=null; this.src='/images/not_found.png';">
        </a>
        <div class="book-info">
            <a th:href="@{/books/detail/{title}(title=${book.bookTitle})}">
                <h3 th:text="${book.bookTitle}">ì±… ì œëª©</h3>
            </a>
            <p><strong>ì €ì:</strong> <span th:text="${book.bookAuth}"></span></p>
            <p><strong>ì¶œíŒì‚¬:</strong> <span th:text="${book.bookPub}"></span></p>
            <p><strong>ì¶œíŒ ì—°ë„:</strong> <span th:text="${book.bookPubYear}"></span></p>
            <p><strong>ê°€ê²©:</strong> <span th:text="${book.discount}"></span> ì›</p>
            <p><strong>ISBN:</strong> <span th:text="${book.ISBN}"></span></p>
        </div>
        <div class="book-actions">
            <a class="detail-btn" th:href="${book.link}" target="_blank">ğŸ”— ìì„¸íˆ ë³´ê¸°</a>
            <button class="bookmark-btn"
                    th:data-title="${book.bookTitle}"
                    th:data-auth="${book.bookAuth}"
                    th:data-pub="${book.bookPub}"
                    th:data-pubyear="${book.bookPubYear}"
                    th:data-des="${book.des != null and book.des.length() > 0 ? #strings.substring(book.des, 0, (book.des.length() > 400 ? 400 : book.des.length())) + (book.des.length() > 400 ? '...' : '') : ''}"
                    th:data-link="${book.link}"
                    th:data-discount="${book.discount}"
                    th:data-isbn="${book.ISBN}"
                    th:data-img="${book.img}"
                    onclick="bookmarkBook(this)">â­ ë¶ë§ˆí¬</button>
        </div>
    </div>
</div>

<div class="pagination">
    <!-- ì´ì „ ë²„íŠ¼ -->
    <span th:if="${currentPageStart > 1}">
        <a th:href="@{/books(searchText=${searchText}, Start=${prevStart})}">â—€ ì´ì „</a>
    </span>

    <!-- í˜ì´ì§€ ë²”ìœ„ ì¶œë ¥ (10ê°œì”© ì¶œë ¥) -->
    <span th:each="i : ${#numbers.sequence(currentPageStart, currentPageEnd)}">
        <a th:href="@{/books(searchText=${searchText}, Start=${i})}" th:text="${i}"></a>
    </span>

    <!-- ë‹¤ìŒ ë²„íŠ¼ -->
    <span th:if="${currentPageEnd < totalPages}">
        <a th:href="@{/books(searchText=${searchText}, Start=${nextStart})}">ë‹¤ìŒ â–¶</a>
    </span>
</div>


<div class="login-btn" th:if="${session.nickname == null}">
<a th:href="@{/naver/login}">
    <img src="https://static.nid.naver.com/oauth/small_g_in.PNG" alt="ë„¤ì´ë²„ ë¡œê·¸ì¸ ë²„íŠ¼">
</a>
</div>
<div class="user-info" th:if="${session.nickname != null}">
    <p><strong>í™˜ì˜í•©ë‹ˆë‹¤, <span th:text="${session.nickname}"></span>ë‹˜!</strong></p>
    <a th:href="@{/mypage/{name}(name=${session.nickname})}">ë§ˆì´í˜ì´ì§€</a>
    <a th:href="@{/logout}">ë¡œê·¸ì•„ì›ƒ</a>
</div>

<div class="no-result" th:if="${books.size() == 0}">
    <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜</p>
</div>
</body>
</html>
